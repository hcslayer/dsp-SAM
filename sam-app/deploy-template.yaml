AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "Test run of the SAM platform. At first glance, SAM may be a way to avoid\
  \ the headaches and complexities of API gateway and Lambda integration.  TO TEST\
  \ \n  - CORS enabled API gateway with GET and POST routes. \n  - Dummy lambdas for\
  \ the routes \n  - S3 based storage and CI/CD pipelines \n  - Cloudwatch events\
  \ and internal lambda functions \n"
Parameters:
  Env:
    Description: The SAM application context.
    Type: String
    AllowedValues:
    - TESTING
    - DEV
    - PROD
    Default: TESTING
Globals:
  Function:
    Runtime: python37
    Timeout: 5
    Tracing: PassThrough
    Environment:
      Variables:
        APP_ENV:
          Ref: Env
Resources:
  LambdaTestRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Action: sts:AssumeRole
          Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
      Path: /
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/AWSLambdaFullAccess
      - arn:aws:iam::aws:policy/AmazonS3FullAccess
      - arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess
      - arn:aws:iam::aws:policy/AmazonElasticMapReduceFullAccess
      - arn:aws:iam::aws:policy/AmazonSSMFullAccess
      - arn:aws:iam::aws:policy/AWSGlueConsoleFullAccess
      - arn:aws:iam::aws:policy/AmazonSageMakerFullAccess
      - arn:aws:iam::aws:policy/AWSCloudFormationFullAccess
      - arn:aws:iam::aws:policy/AmazonAPIGatewayInvokeFullAccess
      - arn:aws:iam::aws:policy/CloudWatchFullAccess
      - arn:aws:iam::aws:policy/CloudWatchEventsFullAccess
      Policies:
      - PolicyName: apig
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Action:
            - execute-api:*
            Effect: Allow
            Resource: arn:aws:execute-api:*:*:*
  NotebooksGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Role:
        Fn::GetAtt:
        - LambdaTestRole
        - Arn
      CodeUri: s3://dsp-sam-conv/e2012a7d88a3a8f3dca82b197890945b
      Handler: main.handler
      Runtime: python3.7
      Events:
        ApiGet:
          Type: Api
          Properties:
            Path: /notebooks
            Method: get
  NotebooksPostFunction:
    Type: AWS::Serverless::Function
    Properties:
      Role:
        Fn::GetAtt:
        - LambdaTestRole
        - Arn
      CodeUri: s3://dsp-sam-conv/879f416b547c29e1516ae75b53f109f1
      Handler: main.handler
      Runtime: python3.7
      Events:
        ApiPost:
          Type: Api
          Properties:
            Path: /notebooks
            Method: post
  NotebooksSubIdGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Role:
        Fn::GetAtt:
        - LambdaTestRole
        - Arn
      CodeUri: s3://dsp-sam-conv/9cf5b75106b32660e00ba5a2d5223ae1
      Handler: main.handler
      Runtime: python3.7
      Events:
        ApiGetSubresource:
          Type: Api
          Properties:
            Path: /notebooks/{id}
            Method: get
  JobsPostFunction:
    Type: AWS::Serverless::Function
    Properties:
      Role:
        Fn::GetAtt:
        - LambdaTestRole
        - Arn
      CodeUri: s3://dsp-sam-conv/9463fbb8bf41422a4b3ba11ed45dec1a
      Handler: main.handler
      Runtime: python3.7
      Events:
        ApiPostJob:
          Type: Api
          Properties:
            Path: /jobs
            Method: post
  JobsGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Role:
        Fn::GetAtt:
        - LambdaTestRole
        - Arn
      CodeUri: s3://dsp-sam-conv/d95b76ea01fb2d24023c2e5afa0aa7d5
      Handler: main.handler
      Runtime: python3.7
      Events:
        ApiGetJob:
          Type: Api
          Properties:
            Path: /jobs
            Method: get
  SageMakerNotebookLinkInternal:
    Type: AWS::Serverless::Function
    Properties:
      Role:
        Fn::GetAtt:
        - LambdaTestRole
        - Arn
      CodeUri: s3://dsp-sam-conv/7c93f24ea465db22756a3c29309348c0
      Handler: main.handler
      Runtime: python3.7
      Events:
        ClusterEvent:
          Type: CloudWatchEvent
          Properties:
            Pattern:
              source:
              - aws.emr
              detail-type:
              - EMR Cluster State Change
              detail:
                state:
                - STARTING
